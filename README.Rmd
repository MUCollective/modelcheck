---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# Modelcheck: An R package for generating model check visualizations

<!-- badges: start -->
<!-- badges: end -->

`modelcheck` is a visualization grammar designed to make it easy to generate informative visualizations for model checking. The `modelcheck` grammar assumes a basic workflow for creating model checks. First, the model predictions or model features need to be extracted as a **distribution** of data from a model object, i.e. data tidying. Then the user must specify an **uncertainty representation** to describe the selected distribution(s). They must also specify the presentation of the observed data. The user can choose among multiple **comparative layouts** to structure their comparison between observed data and model predictions.

## Installation

You can install the development version of modelcheck from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("MUCollective/modelcheck")
```

## Usage

### Background: model

We use a simple model to show the usage of `modelcheck`.

```{r}
library(brms)
model = brm(
  bf(mpg ~ disp + vs + am,
     sigma ~ vs + am),
  init = "0",
  data = mtcars,
  iter = 6000,
  
  file = "models/example_model.rds" # cache model (can be removed)  
)
```

The results...

```{r}
model
```

### Examples

You can create a default model check to do a posterior predictive check by using `mcplot()` (using `coord_flip()` to flip the response variable to the x-axis).

```{r}
library(modelcheck)
library(ggplot2)
library(dplyr)
model %>%
  mcplot() +
  mc_gglayer(coord_flip())
```

To control how the distribution is drawn from model, you can add a `mc_distribution()` to `mcplot()`. For example, there are two push forward transformations `mu` and `sigma` besides the predictive distribution in the Gaussian example model we are using. Here, we are drawing the posterior distribution of `mu` from the Gaussian model.

```{r}
model %>%
  mcplot() +
  mc_distribution("mu") +
  mc_gglayer(coord_flip())
```

To add marginal effects check, you can use `mc_condition_on()` to add an x-axis, row grid, and column grid.

```{r}
model %>%
  mcplot() +
  mc_distribution("mu") +
  mc_condition_on(x = vars(disp))
```

Or you can check the distribution of `sigma` in the model by specifying `mc_distribution("sigma")`. You may find, however, that the unit of the observed data is misaligned with the `sigma` distribution. You can add `observation_transform` to `mcplot()` to transform the observed data to a comparable standard deviation unit to `sigma`.

```{r}
sd_function = function(df) {df %>% group_by(vs) %>% mutate(observation = sd(observation))}

model %>%
  mcplot(observation_transform = sd_function) +
  mc_distribution("sigma") +
  mc_condition_on(x = vars(vs))
```

For model checks that have a continuous conditional variable, `modelcheck` implements uncertainty representations like line + ribbon plot and point + interval plot that encode the uncertainty in the model prediction and reveal the trend of the response variable over values of the conditional variable. For model checks for which no conditional variable is specified, or for which a discrete conditional variable is specified, `modelcheck` implements uncertainty representations like dotplot, eye plot, and gradient plot that show the distribution of the model predictions.

You can use `mc_model_lineribbon()` to use line + ribbon plot to check the trend over values of `mpg` with uncertainty in the model predictions encoded as a ribbon.

```{r}
model %>%
  mcplot() +
  mc_distribution("mu") +
  mc_condition_on(x = vars(disp)) +
  mc_model_lineribbon()
```
If the predictions are conditional on a discrete variable, you can use `mc_model_dots`.

```{r}
model %>%
  mcplot(observation_transform = sd_function) +
  mc_distribution("sigma") +
  mc_model_dots() +
  mc_condition_on(x = vars(vs))
```

`mcplot()` superimposes the model predictions and data observations by default. You can change that by using `mc_layout_*()`. Here we change the comparative layout to juxtaposition.

```{r}
model %>%
  mcplot() +
  mc_distribution("mu", ndraws = 500) +
  mc_condition_on(x = vars(disp)) +
  mc_model_lineribbon() +
  mc_layout_juxtaposition()
```


